import { env } from "@/lib/env";
import { GoogleGenerativeAI } from "@google/generative-ai";
import { type Context, Hono } from "hono";

const genAI = new GoogleGenerativeAI(env.GEMINI_API_KEY);

const app = new Hono().get("/:reportId", (c) => run(c));
export default app;

async function run(c: Context) {
  // The Gemini 1.5 models are versatile and work with both text-only and multimodal prompts
  const model = genAI.getGenerativeModel({
    model: "gemini-2.0-flash",
    generationConfig: {
      responseMimeType: "application/json",
    },
  });

  const prompt = `# 出力フォーマット仕様書
あなたは、日報の内容を評価するAIエージェントです。
以下の仕様に従って、日報の内容を評価し、ポジティブなコメントを出力してください。

## 出力ルール
- 数値は全て半角
- 各出力は50文字まで
- 禁止語句: "と思います", "た方がいい"
- ポジティブな内容を中心
- 評価基準: 客観性 > 網羅性

## 出力フォーマット指定
以下のJSONスキーマを厳守:
{
  "analysisSections": {
    "configuration": "{構成評価}",
    "fulfilling": "{充実度評価}",
    "comprehensive": ["{改善点1}", "{改善点2}"]
  },
  "score": 1~10までの整数か0.5刻みの小数,
  "comment": "{ポジティブなコメント}"
}

### 出力例
{
  "analysisSections": {
    "configuration": "記事の構造は明確で、読み手に伝わりやすい形式になっています。特に、セクション分けが効果的です。",
    "fulfilling": "学習内容と気づきが具体的に記述されており、読み手の理解を促進しています。",
    "comprehensive": ["具体的な例や図表を追加することで、より理解が深まるでしょう","次のアクションにタイムラインを設定すると、目標がより明確になります"]
  },
  "score": 8.5,
  "comment": "優れた学習記録です。改善点を意識することで、さらに質の高い日報になるでしょう。"
}

## レビューしてもらいたい日報データ
\`\`\` md
## **前回のTry振り返り**

- note
    - 前回のTryの振り返りをする
    - Tryにどのような効果があったか？今後も継続するか
    - 継続する場合、「Try（過去からの継続）」に移す
-

## **業務内容と所感**

- note
    - 時系列に今日の作業内容を記述する
    - それぞれの作業内容の下にその作業に対する所感を記述する
    - 所感が「感想（単にその時感じたことや思ったことを述べたもの）」にならないよう注意
    - 自分の行動を振り返り、次の行動に生かすための日報で、次につながらない「感想」を書いても意味がないため
    - 所感には「なぜそう感じたのか」「このような改善が必要」「わかったこと・気付いたこと」など自分の考察や具体案まで含めて記述する（以下例）
        - X: 「今日はデプロイ作業で障害を起こしてしまい悔しかった」
        - O: 「今日はデプロイ作業時に障害を起こしてしまった。ステージングと本番でデータ量に差異があり、負荷を正しく計測できていなかったのが原因。次回はステージングのデータ量を本番と揃えてテストするようにしたい」
- burikaigi
    - WebプラットフォームのInteroperabilityを実現するのセッション
        -
    - 自分の技術領域から外れてる分野が多いんで，droidkaigiレベルの充実したイベントにはならないと考えていたけど，広い領域の知見が増えて結構よかった．こういう関係ないと思ってたものが繋がっていくのがすごく楽しいんだろうなって思う
    - azure Ai pratformの話，知識の結び付けが全くできずにかなりグダってしまった
        - 全く頭に入ってこない
        - 説明速度が高いのもあるんだろうけど，一個一個に対して吸収しようと思えない
        - スライドの文章量と話での内容量に乖離があると，内容を追っていくのが結構大変になるってことがわかった
    - 全体を振り返って
        - 質問等を行うとかはしなかったが，セッション全体の理解度は現状わかっていて，このセッションから何を学びたいのかを理解することでかなり理解度が高まった印象
        - 後半は特にご飯を食べることができていなかったせいか，集中力が切れて内容理解に脳のリソースをフルに使えなかった
- fateボドゲ開発ミーティング
    - 素直な質問を素直に投げることができた．疲れていたことも関連しているかもしれないが，今後取り組もうとしていることを一度しっかり考えていた経歴があること，Unityに関してある程度予備知識があったことも関わってそう．
    - サーバー関連とUnity関連のタスクで迷ってUnityのタスクを成り行きでもらいに行ったが，結局自分は何を選ぶべきだったのか
        - 予備知識あるのはUnityだし，中途半端な知識すらないサーバーサイドの実装を無理に触りにいくデメリットとしては，JPHACKSみたいに作業工程の見積もりミスが発生するのは考えられる．一方で，知らないなら知らないで，技術の選定ミスが発生する恐れもある．
        - 最初のタスクとしての選択は正解じゃなかったかもしれないけど，間違いでもなかったと思う．スタートダッシュの時点で重いタスクを持って失速するよりは，軽い感じでモチベーションを持てるようにした方がいい．ただ，どのみちgs2と結合する部分の知識は入れておかないと無駄に煽った手戻りを自分で発生させることにつながるかもしれない．
    - 思ったよりモチベーションが煽られなかった

## **よかった点（Keep）**

- note
    - 業務内容と所感から良かった点を抽象化して抽出する。今後もできそうなことを言語化して次の仕事に活かす
    - 自分のモチベーションアップのためにも、悪いところだけでなく良かったところを探すのは大事
- かなりマルチな知識の吸収ができた
- 睡眠不足であったが，集中して聴講できた
- fateのボドゲミーティングで素直な疑問点を遠慮なく投げることができてよかった

## **改善したい点（Problem）**

- note
    - 業務内容と所感から改善したい点を抽出する
- 直前まで大事な予定を忘れてドタバタな日程になったこと

## **次回試すこと（Try）**

- note
    - Problemを解消するために次にすべきこと・試すことを記述
    - 実際に実行するためには、なるべく具体的な案にするのが大切
        - X:「来週はSQLの勉強を頑張る」
        - o:「来週は〇〇というSQLの本に一日５ページずつ取り組む」
-

## **Try（過去からの継続）**

- note
    - Tryで継続中のものはここに記述する
    - 完全に習慣化したものについては消していく
-

## **今日学習したこと**

- note
    - 業務中・業務外含めて今日学習したことを読み手を意識して分かりやすくアウトプットする
    - 本や記事の文章をコピーするにではなく、なるべく「自分の言葉」で書くのが理解を深めるためには重要
-

## 今日生み出したもの

- note
    - この現実世界に自信が生み出したものをかく
-

## 今日関わった人(深く知らない人，初対面の人)

- note

    相手のことを忘れないように，重要な知見を覚えていけるように

- saku さん
    - https://x.com/sakupi01
    - burikaigiセッションでWebの話している人
    - サイボウズの人らしい
    - サイボウズらしい，Interoperability（相互運用性）の話だったけど，Webだったので内容がなんとなくの掴みしか得られなかった
- 森　友梨映さん
    - https://x.com/1115_lilium
    - DevOpsエンジニア
    - Microsoft MVP for Developer Technologies
    - zenn記事もいっぱい書いているらしい
- 岩田 泰明さん
    - https://x.com/iwtn_
    - エンジニアのキャリア整理実践編の人
    - 株式会社リブセンス
    - Webアプリケーションエンジニア
    - 採用候補も最近している
- 井上 章 さん
    - https://x.com/chack411
    - 日本マイクロソフトのアーキテクト第一なんとかって場所にいる
- 工藤淳さん
    - ソリューションアーキテクト
    - iretっていう会社にいる
    - microsoft mvp
    - コミュニティ運営がかなり多い
        - gpt
        - zure
        - os summit
        - ai dev
        - security jaws
        - azure travelers 諸々
- 中村 学さん
    - https://x.com/gakuzzzz
    - map/filter関数のセッション
    - tech to valueのCEO
- 梶川 琢馬さん
    - https://x.com/kajitack
    - techbowlでプロダクトエンジニアをしている方
- りいたさん
    - https://x.com/riita10069
    - awsの人
- こーめいさん
    - https://x.com/kongmingtrap
    - クラスメソッドの人(Zenn?)
- 籾井さん
    - burikaigiの良さを一緒に後輩に伝える
-

## **今日の雑感**

- note
    - 業務に関係したものでも関係ないものでも構わない
    - 他の人とコミュニケーションを取れるようなものが良い
    - 質問を投げると返信をもらえる率が上がる（経験談）
- やっぱりカンファレンスはいいなぁ

## 明日やること

## 今後やりたいこと，野望

[Untitled](https://www.notion.so/18df11f6d62481b3918eea7371f1a549?pvs=21)
\`\`\`

`;

  const result = await model.generateContent(prompt);
  const response = await result.response;
  const text = response.text();
  return c.json({ text });
}
